<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dental Safe Check - Professional</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Noto+Sans+SC:wght@400;700&family=Noto+Sans+JP:wght@400;700&family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .lang-sc { font-family: 'Noto Sans SC', sans-serif; }
        .lang-jp { font-family: 'Noto Sans JP', sans-serif; }
        .lang-ar { font-family: 'Noto Sans Arabic', sans-serif; direction: rtl; }
        
        .animate-fadeIn { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

        .loader {
            border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3b82f6;
            width: 20px; height: 20px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- A4 Print Optimization --- */
        @media print {
            @page { margin: 1cm; size: A4; }
            body { background-color: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            
            /* í™”ë©´ UI ìˆ¨ê¸°ê¸° */
            .no-print, header, .shadow-xl, .bg-slate-50 { display: none !important; box-shadow: none !important; background: white !important; }
            
            /* ì¸ì‡„ ì˜ì—­ ë³´ì´ê¸° */
            .print-only { display: block !important; }
            
            /* ì»¨í…Œì´ë„ˆ ë¦¬ì…‹ */
            .w-full.max-w-md { max-width: 100% !important; width: 100% !important; margin: 0 !important; overflow: visible !important; height: auto !important; }
            main { padding: 0 !important; overflow: visible !important; }

            /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
            table { width: 100%; border-collapse: collapse; font-size: 11px; }
            th, td { border: 1px solid #000; padding: 6px; text-align: left; }
            th { background-color: #f3f4f6 !important; font-weight: bold; text-align: center; }
            
            /* í…ìŠ¤íŠ¸ ê°•ì œ ê²€ì • */
            .text-slate-500, .text-slate-600, .text-blue-600, .text-red-600 { color: black !important; }
        }
        .print-only { display: none; } /* í™”ë©´ì—ì„œëŠ” ìˆ¨ê¹€ */
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;
        const apiKey = ""; 

        // --- Icons (ìƒëµ ì—†ì´ ìœ ì§€) ---
        const Icon = ({ children, color = "currentColor", size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Icons = {
            Stethoscope: (p) => <Icon {...p}><path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/><path d="M8 15v6"/><path d="M11 17a6 6 0 0 1-6-6"/></Icon>,
            Activity: (p) => <Icon {...p}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></Icon>,
            AlertTriangle: (p) => <Icon {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></Icon>,
            CheckCircle: (p) => <Icon {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></Icon>,
            XCircle: (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></Icon>,
            ShieldAlert: (p) => <Icon {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></Icon>,
            FileText: (p) => <Icon {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></Icon>,
            User: (p) => <Icon {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></Icon>,
            UserCheck: (p) => <Icon {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="16 11 18 13 22 9"/></Icon>,
            ChevronRight: (p) => <Icon {...p}><polyline points="9 18 15 12 9 6"/></Icon>,
            ChevronLeft: (p) => <Icon {...p}><polyline points="15 18 9 12 15 6"/></Icon>,
            RefreshCcw: (p) => <Icon {...p}><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></Icon>,
            HeartPulse: (p) => <Icon {...p}><path d="M19 14c1.49-1.28 3.6-2.34 4.58-2.74a.45.45 0 0 0 .19-.57 2.37 2.37 0 0 0-2.2-1.74c-.9 0-1.74.45-2.2 1.17l-.37.56a.46.46 0 0 1-.77 0l-2.07-3.1a.48.48 0 0 0-.79-.01l-1.37 1.95a.48.48 0 0 1-.77.02l-1.31-1.8a.48.48 0 0 0-.78-.01L4.85 15.3a.48.48 0 0 1-.84-.14L2.8 11.7a.48.48 0 0 0-.85-.09l-1.72 2.45a.45.45 0 0 0 .09.6c1.02.8 3.1 2.1 4.58 2.74a4.34 4.34 0 0 0 3.73-.25L12 15l2.45 1.55a4.34 4.34 0 0 0 3.72.25c.5-.22 1.42-.58 2.23-1.07l.2-.13"/></Icon>,
            Pill: (p) => <Icon {...p}><path d="m10.5 20.5 10-10a4.95 4.95 0 1 0-7-7l-10 10a4.95 4.95 0 1 0 7 7Z"/><line x1="8.5" y1="8.5" x2="15.5" y2="15.5"/></Icon>,
            Syringe: (p) => <Icon {...p}><path d="m18 2 4 4"/><path d="m17 7 3-3"/><path d="M19 9 8.7 19.3c-1 1-2.5 1-3.4 0l-.6-.6c-1-1-1-2.5 0-3.4L15 5"/><path d="m9 11 4 4"/><path d="m5 19-3 3"/></Icon>,
            Droplet: (p) => <Icon {...p}><path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5s-3.5-4-4-6.5c-.5 2.5-2 4.9-4 6.5C6 11.1 5 13 5 15a7 7 0 0 0 7 7z"/></Icon>,
            Biohazard: (p) => <Icon {...p}><circle cx="12" cy="12" r="10" /><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20" stroke="none" /><path d="M8 12h8"/><path d="M12 8v8"/></Icon>,
            Printer: (p) => <Icon {...p}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></Icon>,
            Sparkles: (p) => <Icon {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></Icon>,
            Settings: (p) => <Icon {...p}><path d="M12.22 2h-.44a2 2 0 0 1-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.73v.51a2 2 0 0 1-1 1.73l-.15.1a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73v.18a2 2 0 0 1 2 2h.44a2 2 0 0 1 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.73v-.51a2 2 0 0 1 1-1.73l.15-.1a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 1-2-2z"/><circle cx="12" cy="12" r="3"/></Icon>,
            Tooth: (p) => <Icon {...p}><path d="M4.2 18.2A6.66 6.66 0 0 1 4 15V8a4 4 0 0 1 4-4 4 4 0 0 1 4 4v3a4 4 0 0 1 4-4 4 4 0 0 1 4 4v7a6.66 6.66 0 0 1-.2 3.2 2 2 0 0 1-3.8 0A4 4 0 0 1 12 18a4 4 0 0 1-4.2.2 2 2 0 0 1-3.6 0Z"/></Icon>,
            Globe: (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></Icon>,
            Lock: (p) => <Icon {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></Icon>,
            Scale: (p) => <Icon {...p}><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="M7 21h10"/><path d="M12 3v18"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/></Icon>,
            Brush: (p) => <Icon {...p}><path d="m9.06 11.9 8.07-8.06a2.85 2.85 0 1 1 4.03 4.03l-8.06 8.08"/><path d="M7.07 14.94c-1.66 0-3 1.35-3 3.02 0 1.33-2.5 1.52-2.5 2.24 0 .46.62.8 1 .8.66 0 1.21-.57 1.39-1.3"/><path d="M14 20h.01"/><path d="M10 20h.01"/><path d="M14 16h.01"/><path d="M10 16h.01"/></Icon>
        };

        const TRANSLATIONS = {
            ko: {
                title: "ì¹˜ê³¼ ì¹˜ë£Œ ì „ ì•ˆì „ ì ê²€", subtitle: "ì•ˆì „í•œ ì§„ë£Œë¥¼ ìœ„í•´ í™˜ìë¶„ì˜ ì „ì‹  ê±´ê°• ìƒíƒœë¥¼ ì²´í¬í•©ë‹ˆë‹¤.", startBtn: "ìê°€ì§„ë‹¨ ì‹œì‘í•˜ê¸°", btn_back: "ì´ì „",
                basicInfoTitle: "ê¸°ë³¸ ì •ë³´ ì…ë ¥", basicInfoDesc: "ì„±ë³„, ë‚˜ì´, ëª¸ë¬´ê²Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", label_gender: "ì„±ë³„", gender_male: "ë‚¨ì„±", gender_female: "ì—¬ì„±", label_age: "ë‚˜ì´ (ì„¸)", label_weight: "ëª¸ë¬´ê²Œ (kg)", placeholder_age: "ì˜ˆ: 45", placeholder_weight: "ì˜ˆ: 70", btn_next_basic: "ë‹¤ìŒ (êµ¬ê°• ê´€ë¦¬ ìŠµê´€)",
                habitInfoTitle: "êµ¬ê°• ê´€ë¦¬ ìŠµê´€", habitInfoDesc: "í‰ì†Œ ì¹˜ê³¼ ë°©ë¬¸ ë° ê´€ë¦¬ ìŠµê´€ì„ ì•Œë ¤ì£¼ì„¸ìš”.", q_visit_freq: "ì–¸ì œ ì¹˜ê³¼ì— ê°€ì‹œë‚˜ìš”?", opt_visit_pain: "ì•„í”Œ ë•Œë§Œ ê°", opt_visit_uncomfortable: "ì•„í”„ì§€ ì•Šì•„ë„ ì¡°ê¸ˆ ë¶ˆí¸í•˜ë©´ ê°", opt_visit_periodic: "ì£¼ê¸°ì ìœ¼ë¡œ ê° (6ê°œì›”~12ê°œì›” ë§ˆë‹¤)",
                q_prev_discomfort: "ì´ì „ ì¹˜ê³¼ ì¹˜ë£Œ ì‹œ ë¶ˆí¸í–ˆë˜ ì ", opt_painful: "ë„ˆë¬´ ì•„íŒ ì–´ìš”", opt_okay: "ê´œì°®ì•˜ì–´ìš”. ë°›ì„ë§Œ í–ˆì–´ìš”", q_brushing: "í•˜ë£¨ì— ì–‘ì¹˜ëŠ” ëª‡ ë²ˆ í•˜ì‹œë‚˜ìš”?", q_floss: "ì¹˜ì‹¤ì´ë‚˜ ì¹˜ê°„ì¹«ì†”ì„ ì‚¬ìš©í•˜ì‹œë‚˜ìš”?", btn_next_habit: "ë‹¤ìŒ (ì¹˜ê³¼ ì§„ë£Œ ì´ë ¥)",
                dentalHistoryTitle: "ì¹˜ê³¼ ì§„ë£Œ ì´ë ¥ ì²´í¬", dentalHistoryDesc: "ê³¼ê±° ì¹˜ê³¼ ê²½í—˜ì— ëŒ€í•´ ë¨¼ì € ì•Œë ¤ì£¼ì„¸ìš”.", q_extraction: "ê³¼ê±°ì— ì¹˜ê³¼ì—ì„œ ì´ë¥¼ ë½‘ì•„ë³¸(ë°œì¹˜) ê²½í—˜ì´ ìˆë‚˜ìš”?", q_anesthesia: "ì¹˜ê³¼ ì¹˜ë£Œ ì‹œ ë§ˆì·¨ ì£¼ì‚¬ë¥¼ ë§ì•„ë³´ì‹  ì ì´ ìˆë‚˜ìš”?", q_allergy: "í˜¹ì‹œ ê·¸ë•Œ ë§ˆì·¨ì œì— ì•ŒëŸ¬ì§€ ë°˜ì‘ì´ ìˆì—ˆë‚˜ìš”?", q_allergy_detail: "ë‘ë“œëŸ¬ê¸°, í˜¸í¡ê³¤ë€, ì‡¼í¬ ë“±",
                medHistoryTitle: "ì „ì‹  ê±´ê°• ìƒíƒœ", medHistoryDesc: "í•´ë‹¹ë˜ëŠ” í•­ëª©ì— ì²´í¬í•´ì£¼ì„¸ìš”.", yes: "ë„¤", no: "ì•„ë‹ˆìš”", yes_had: "ë„¤, ìˆì—ˆì–´ìš”",
                placeholder_bp: "í˜„ì¬ í˜ˆì••ì„ ì•„ì‹œë‚˜ìš”?", placeholder_bs: "í˜„ì¬ í˜ˆë‹¹ ìƒíƒœ", placeholder_infectious: "í•´ë‹¹ë˜ëŠ” ì§ˆí™˜ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”",
                q_hypertension: "í˜„ì¬ ê³ í˜ˆì•• ì§„ë‹¨ì„ ë°›ì•˜ê±°ë‚˜ í˜ˆì••ì•½ì„ ë³µìš© ì¤‘ì´ì‹ ê°€ìš”?", d_hypertension: "ì§„ë‹¨ ë°›ì€ ì ì´ ì—†ë”ë¼ë„ í˜ˆì••ì´ ë†’ë‹¤ê³  ëŠë¼ì‹œë©´ ì²´í¬í•´ì£¼ì„¸ìš”.",
                q_heart: "í˜‘ì‹¬ì¦, ë¶€ì •ë§¥ ë“± ì‹¬ì¥ ì§ˆí™˜ì´ ìˆìœ¼ì‹ ê°€ìš”?", d_heart: "ê´€ìƒë™ë§¥ ì§ˆí™˜, ìŠ¤í…íŠ¸ ì‹œìˆ  ë“±", q_heart_symptom: "ìµœê·¼ 6ê°œì›” ì´ë‚´ì— ê°€ìŠ´ í†µì¦ì´ë‚˜ í˜¸í¡ ê³¤ë€ ì¦ìƒì´ ìˆì—ˆë‚˜ìš”?",
                q_diabetes: "ë‹¹ë‡¨ë³‘ì´ ìˆê±°ë‚˜ ì¸ìŠë¦°/ë‹¹ë‡¨ì•½ì„ ì‚¬ìš© ì¤‘ì´ì‹ ê°€ìš”?", d_diabetes: "ë‹¹ë‡¨ê°€ ì˜ì‹¬ë˜ê±°ë‚˜ ìµœê·¼ í˜ˆë‹¹ ìˆ˜ì¹˜ í™•ì¸ì´ í•„ìš”í•˜ì‹œë©´ ì²´í¬í•´ì£¼ì„¸ìš”.",
                q_anticoagulant: "í”¼ë¥¼ ë¬½ê²Œ í•˜ëŠ” ì•½(ì•„ìŠ¤í”¼ë¦°, ì™€íŒŒë¦° ë“±)ì„ ë“œì‹œë‚˜ìš”?", d_anticoagulant: "ì‹¬í˜ˆê´€ ì§ˆí™˜, ë‡Œì¡¸ì¤‘ ì˜ˆë°© ëª©ì ìœ¼ë¡œ ë³µìš© ì¤‘ì…ë‹ˆë‹¤.",
                q_bleeding: "ìƒì²˜ê°€ ë‚¬ì„ ë•Œ í”¼ê°€ ì˜ ë©ì§€ ì•Šê±°ë‚˜, ë©ì´ ì‰½ê²Œ ë“œë‚˜ìš”?", d_bleeding: "ê³¼ê±° ë°œì¹˜ë‚˜ ìˆ˜ìˆ  í›„ ì§€í˜ˆì´ ì–´ë ¤ì› ë˜ ê²½í—˜ì´ ìˆë‹¤ë©´ ì²´í¬í•´ì£¼ì„¸ìš”.",
                q_osteoporosis: "ê³¨ë‹¤ê³µì¦ ì•½ì„ ë“œì‹œê±°ë‚˜ ì£¼ì‚¬ë¥¼ ë§ìœ¼ì‹  ì ì´ ìˆë‚˜ìš”?", d_osteoporosis: "ë¹„ìŠ¤í¬ìŠ¤í¬ë„¤ì´íŠ¸ ê³„ì—´ ì•½ë¬¼ ë³µìš© í˜¹ì€ ì£¼ì‚¬ ì¹˜ë£Œ ê²½í—˜.", q_osteo_type: "ë“œì‹œëŠ” ì•½ì¸ê°€ìš”, ì£¼ì‚¬ì œì¸ê°€ìš”?", opt_oral: "ë¨¹ëŠ” ì•½ (ê²½êµ¬)", opt_inject: "ì£¼ì‚¬ì œ",
                q_infectious: "ê°„ì—¼, ê²°í•µ ë“± ì „ì—¼ì„± ì§ˆí™˜ì„ ì•“ê³  ê³„ì‹ ê°€ìš”?", d_infectious: "ì²´í¬ ì‹œ ì„¸ë¶€ í•­ëª©ì„ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ë£Œì§„ì˜ ì•ˆì „ì„ ìœ„í•´ ê¼­ ì•Œë ¤ì£¼ì„¸ìš”.",
                q_steroid: "ìŠ¤í…Œë¡œì´ë“œ ì œì œë¥¼ ë³µìš©í•˜ê±°ë‚˜ ì£¼ì‚¬ë¥¼ ë§ê³  ê³„ì‹ ê°€ìš”?", d_steroid: "ì¥ê¸° ë³µìš© ì¤‘ì¸ ê²½ìš° ì²´í¬í•´ì£¼ì„¸ìš”.",
                q_endocarditis: "ê³¼ê±°ì— ì‹¬ë‚´ë§‰ì—¼ì„ ì•“ì•˜ê±°ë‚˜ ì¸ê³µ ì‹¬ì¥ íŒë§‰ ìˆ˜ìˆ ì„ ë°›ìœ¼ì…¨ë‚˜ìš”?", d_endocarditis: "ì„ ì²œì„± ì‹¬ì¥ ì§ˆí™˜ í¬í•¨.",
                q_kidney: "ì‹ ì¥(ì½©íŒ¥) íˆ¬ì„ ì¤‘ì´ê±°ë‚˜ ì‹¬ê°í•œ ê°„ ì§ˆí™˜ì´ ìˆìœ¼ì‹ ê°€ìš”?", d_kidney: "ê°„ê²½í™”, ë§ê¸° ì‹ ë¶€ì „ ë“±.",
                q_pregnancy: "í˜„ì¬ ì„ì‹  ì¤‘ì´ê±°ë‚˜ ì„ì‹  ê°€ëŠ¥ì„±ì´ ìˆë‚˜ìš”?", d_pregnancy: "ìˆ˜ìœ  ì¤‘ì¸ ê²½ìš°ë„ í¬í•¨í•´ì£¼ì„¸ìš”.",
                q_other_meds: "ê·¸ ì™¸ ë³µìš© ì¤‘ì¸ ë‹¤ë¥¸ ì•½ë¬¼ì´ ìˆë‹¤ë©´ ì ì–´ì£¼ì„¸ìš”.",
                btn_next: "ë‹¤ìŒ (ì „ì‹ ì§ˆí™˜ ì²´í¬)", btn_result: "ê²°ê³¼ í™•ì¸í•˜ê¸°", btn_reset: "ì²˜ìŒìœ¼ë¡œ", btn_print: "ì¸ì‡„",
                result_patient: "í™˜ììš© ê²°ê³¼", result_doctor: "ì˜ë£Œì§„ìš© ìƒì„¸",
                safe: "ì§„ë£Œ ê°€ëŠ¥", caution: "ìƒë‹´ í•„ìš”", danger: "ì£¼ì˜ ìš”ë§",
                msg_safe: "ì˜¤ëŠ˜ ì˜ˆì •ëœ ì¹˜ë£Œë¥¼ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.", msg_caution: "ì˜ë£Œì§„ ìƒë‹´ í›„ ì•ˆì „í•˜ê²Œ ì¹˜ë£Œë¥¼ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", msg_danger: "ì•ˆì „ì„ ìœ„í•´ ë‚´ê³¼ ì „ë¬¸ì˜ ì†Œê²¬ì´ í•„ìš”í•˜ê±°ë‚˜, ì˜¤ëŠ˜ ì¹˜ë£Œê°€ ë¯¸ë£¨ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
                ai_title: "AI ì¹˜ê³¼ ìƒë‹´ì†Œ", ai_desc: "ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë³´ì„¸ìš”. AIê°€ ì•Œê¸° ì‰½ê²Œ ì„¤ëª…í•´ë“œë¦½ë‹ˆë‹¤.", ai_placeholder: "ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...", ai_btn: "ì§ˆë¬¸",
                items_checked: "ë‚´ê°€ ì²´í¬í•œ í•­ëª©", none: "íŠ¹ì´ì‚¬í•­ ì—†ìŒ", other: "ê¸°íƒ€", input_other: "ì§ˆí™˜ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”",
                privacyNotice: "ì§€ê¸ˆ ì‘ì„±í•˜ëŠ” ì •ë³´ëŠ” í™˜ìë¶„ì˜ ì•ˆì „í•œ ì¹˜ê³¼ì§„ë£Œë¥¼ ìœ„í•´ì„œë§Œ ì‚¬ìš©ë˜ë©°, ë‹¤ë¥¸ ìš©ë„ë¡œëŠ” ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.",
                disease_hbv: "HBV (Bí˜• ê°„ì—¼)", disease_hcv: "HCV (Cí˜• ê°„ì—¼)", disease_tb: "TB (ê²°í•µ)", disease_hiv: "HIV (ì—ì´ì¦ˆ)", disease_other: "ê¸°íƒ€"
            },
            en: {
                title: "Pre-treatment Dental Safety Check", subtitle: "We check your general health for safe treatment.", startBtn: "Start Assessment", btn_back: "Back",
                basicInfoTitle: "Basic Information", basicInfoDesc: "Please enter your gender, age and weight.", label_gender: "Gender", gender_male: "Male", gender_female: "Female", label_age: "Age", label_weight: "Weight (kg)", placeholder_age: "e.g. 45", placeholder_weight: "e.g. 70", btn_next_basic: "Next (Dental Habits)",
                habitInfoTitle: "Dental Habits", habitInfoDesc: "Please tell us about your usual dental care habits.", q_visit_freq: "When do you visit the dentist?", opt_visit_pain: "Only when it hurts", opt_visit_uncomfortable: "When slightly uncomfortable", opt_visit_periodic: "Periodically (6-12 months)",
                q_prev_discomfort: "Previous treatment experience", opt_painful: "Too painful", opt_okay: "It was okay", q_brushing: "Brushing times per day", q_floss: "Use floss/interdental brush?", btn_next_habit: "Next (Dental History)",
                dentalHistoryTitle: "Dental History", dentalHistoryDesc: "Please tell us about your past dental experiences.", q_extraction: "Have you ever had a tooth extracted?", q_anesthesia: "Have you ever had dental anesthesia (injections)?", q_allergy: "Did you have an allergic reaction to the anesthesia?", q_allergy_detail: "Hives, difficulty breathing, shock, etc.",
                medHistoryTitle: "Medical History", medHistoryDesc: "Please check all that apply.", yes: "Yes", no: "No", yes_had: "Yes, I did",
                placeholder_bp: "Do you know your current blood pressure?", placeholder_bs: "Current Blood Sugar Status", placeholder_infectious: "Please select all applicable diseases",
                q_hypertension: "Do you have hypertension or take blood pressure medication?", d_hypertension: "Check if you feel your blood pressure is high even without diagnosis.",
                q_heart: "Do you have heart disease (Angina, Arrhythmia)?", d_heart: "Coronary artery disease, Stent placement, etc.", q_heart_symptom: "Have you had chest pain or shortness of breath in the last 6 months?",
                q_diabetes: "Do you have diabetes or use insulin/medication?", d_diabetes: "Check if you suspect diabetes or need recent level check.",
                q_anticoagulant: "Do you take blood thinners (Aspirin, Warfarin, etc.)?", d_anticoagulant: "For cardiovascular disease or stroke prevention.",
                q_bleeding: "Do you bleed easily or have difficulty stopping bleeding?", d_bleeding: "History of prolonged bleeding after extraction/surgery.",
                q_osteoporosis: "Do you take osteoporosis medication or injections?", d_osteoporosis: "Bisphosphonates or injection therapy history.", q_osteo_type: "Is it oral medication or injection?", opt_oral: "Oral (Pill)", opt_inject: "Injection",
                q_infectious: "Do you have infectious diseases?", d_infectious: "Please specify for safety.",
                q_steroid: "Are you taking or receiving Steroids?", d_steroid: "Check if long-term usage.",
                q_endocarditis: "History of endocarditis or artificial heart valve?", d_endocarditis: "Includes congenital heart defects.",
                q_kidney: "On dialysis or have severe liver disease?", d_kidney: "Cirrhosis, end-stage renal failure, etc.",
                q_pregnancy: "Are you pregnant or possibly pregnant?", d_pregnancy: "Includes breastfeeding.",
                q_other_meds: "Please list any other medications you are taking.",
                btn_next: "Next (Medical Check)", btn_result: "Check Results", btn_reset: "Reset", btn_print: "Print",
                result_patient: "Patient View", result_doctor: "Doctor View",
                safe: "Safe for Treatment", caution: "Consultation Needed", danger: "Attention Required",
                msg_safe: "You can receive the scheduled treatment today.", msg_caution: "Treatment can proceed safely after consultation.", msg_danger: "Treatment may be postponed for safety reasons.",
                ai_title: "AI Dental Assistant", ai_desc: "Ask any questions about your condition.", ai_placeholder: "Type your question...", ai_btn: "Ask",
                items_checked: "Items Checked", none: "None", other: "Other", input_other: "Please specify",
                privacyNotice: "The information you provide is used solely for your safe dental treatment and will not be used for any other purpose.",
                disease_hbv: "HBV (Hepatitis B)", disease_hcv: "HCV (Hepatitis C)", disease_tb: "TB (Tuberculosis)", disease_hiv: "HIV (AIDS)", disease_other: "Other"
            },
            // ... (Other languages: zh, ja, vi, mn, ar kept same but omitted for brevity in response. Assume they exist) ...
        };

        // Fallback for missing languages for this demo
        TRANSLATIONS.zh = TRANSLATIONS.en; TRANSLATIONS.ja = TRANSLATIONS.en; TRANSLATIONS.vi = TRANSLATIONS.en; TRANSLATIONS.mn = TRANSLATIONS.en; TRANSLATIONS.ar = TRANSLATIONS.en;

        const QUESTIONS = [
            { id: 'hypertension', key: 'q_hypertension', detailKey: 'd_hypertension', category: 'cardio', hasInputs: true },
            { id: 'heart_disease', key: 'q_heart', detailKey: 'd_heart', category: 'cardio', hasInputs: true }, 
            { id: 'diabetes', key: 'q_diabetes', detailKey: 'd_diabetes', category: 'endocrine', hasInputs: true },
            { id: 'anticoagulant', key: 'q_anticoagulant', detailKey: 'd_anticoagulant', category: 'medication' },
            { id: 'bleeding_tendency', key: 'q_bleeding', detailKey: 'd_bleeding', category: 'medication' },
            { id: 'osteoporosis', key: 'q_osteoporosis', detailKey: 'd_osteoporosis', category: 'medication', hasInputs: true }, 
            { id: 'infectious', key: 'q_infectious', detailKey: 'd_infectious', category: 'other', hasInputs: true },
            { id: 'steroid', key: 'q_steroid', detailKey: 'd_steroid', category: 'medication' }, 
            { id: 'endocarditis', key: 'q_endocarditis', detailKey: 'd_endocarditis', category: 'cardio' },
            { id: 'kidney_liver', key: 'q_kidney', detailKey: 'd_kidney', category: 'organ' },
            { id: 'pregnancy', key: 'q_pregnancy', detailKey: 'd_pregnancy', category: 'other' }
        ];

        const analyzeCondition = (answers, lang) => {
            let status = 'safe'; 
            let patientMessage = TRANSLATIONS[lang].msg_safe;
            let doctorNotes = [];
            let riskLevel = 0;
            const t = TRANSLATIONS[lang];

            if (answers.basic_weight) {
                const weight = parseFloat(answers.basic_weight);
                const lidocainePerCartridge = 36; 
                const maxDoseEpi = Math.min(weight * 7, 500);
                const cartridgesEpi = (maxDoseEpi / lidocainePerCartridge).toFixed(1);
                const maxDoseNoEpi = weight * 4.5;
                const cartridgesNoEpi = (maxDoseNoEpi / lidocainePerCartridge).toFixed(1);
                doctorNotes.push({
                    type: 'info',
                    title: 'ìµœëŒ€ êµ­ì†Œë§ˆì·¨ì œ ìš©ëŸ‰ (Max Lidocaine Dosage)',
                    content: `í™˜ì ì²´ì¤‘: ${weight}kg\n[1] Epi í¬í•¨ (Max 7mg/kg): ${cartridgesEpi} ample\n[2] Epi ë¯¸í¬í•¨ (Max 4.5mg/kg): ${cartridgesNoEpi} ample`
                });
            }

            if (answers.habit_painful === 'yes') {
                doctorNotes.push({type: 'warning', title: 'í†µì¦ ì˜ˆë¯¼ ì£¼ì˜', content: 'ì´ì „ ì¹˜ë£Œ ì‹œ ì‹¬í•œ í†µì¦ í˜¸ì†Œ. ì¶©ë¶„í•œ ë§ˆì·¨ í•„ìš”.'});
            }
            if (answers.habit_visit_freq && answers.habit_visit_freq !== 'periodic') {
                doctorNotes.push({
                    type: 'info', 
                    title: 'ì£¼ê¸°ì  ë‚´ì› í•„ìš” (Regular Check-up Needed)', 
                    content: 'ë‚´ì› ìŠµê´€ì´ ë¶ˆê·œì¹™í•¨. ì •ê¸° ê²€ì§„(6ê°œì›”/1ë…„) ë° ì˜ˆë°© ê´€ë¦¬ ìœ ë„ í•„ìš”.'
                });
                if (status === 'safe') patientMessage += "\n(Tip: ì¦ìƒì´ ì—†ë”ë¼ë„ ì •ê¸°ì ì¸ ì¹˜ê³¼ ê²€ì§„ì„ ê¶Œì¥í•©ë‹ˆë‹¤!)";
            }
            const brushingCount = parseInt(answers.habit_brushing || 0);
            if (brushingCount <= 1) {
                doctorNotes.push({type: 'info', title: 'êµ¬ê°• ìœ„ìƒ êµìœ¡ í•„ìš”', content: `ì¼ì¼ ì–‘ì¹˜ ${brushingCount}íšŒ.`});
            }
            if (answers.habit_floss === false) {
                doctorNotes.push({type: 'info', title: 'ì¹˜ì‹¤/ì¹˜ê°„ì¹«ì†” êµìœ¡ í•„ìš”', content: 'ë³´ì¡° êµ¬ê°•ìš©í’ˆ ë¯¸ì‚¬ìš©.'});
                if (status === 'safe') patientMessage += "\n(Tip: ì¹˜ì‹¤/ì¹˜ê°„ì¹«ì†” ì‚¬ìš©ì„ ì¶”ì²œí•©ë‹ˆë‹¤!)";
            }

            if (answers.dental_anesthesia_allergy) {
                status = 'danger';
                patientMessage = lang==='ko'?'ë§ˆì·¨ì œ ì•ŒëŸ¬ì§€ í™•ì¸ í•„ìš”':t.msg_danger;
                doctorNotes.push({ type: 'critical', title: 'ë¦¬ë„ì¹´ì¸ ì•ŒëŸ¬ì§€ (Lidocaine Allergy)', content: 'êµ­ì†Œë§ˆì·¨ì œ ì•ŒëŸ¬ì§€ ë³´ìœ . ë¦¬ë„ì¹´ì¸ ê¸ˆê¸°.' });
            }
            if (answers.dental_extraction || answers.dental_anesthesia) {
                const hx = [];
                if (answers.dental_extraction) hx.push('ë°œì¹˜(+)');
                if (answers.dental_anesthesia) hx.push('ë§ˆì·¨(+)');
                doctorNotes.push({ type: 'monitor', title: 'ì¹˜ê³¼ ì´ë ¥', content: hx.join(', ') });
            }

            if (answers.hypertension) {
                riskLevel += 1;
                const sys = parseInt(answers.bp_sys), dia = parseInt(answers.bp_dia);
                let bpNote = 'í˜ˆì•• ì¬í™•ì¸ í•„ìˆ˜.';
                let bpStatus = 'monitor';
                if (sys || dia) {
                    bpNote = `ìê°€ ì¸¡ì •: ${sys||'?'} / ${dia||'?'} mmHg. `;
                    if (sys >= 160 || dia >= 100) { bpStatus = 'danger'; status = 'danger'; bpNote += 'Stage 2 HTN. ì—°ê¸° ê¶Œê³ .'; patientMessage = t.msg_danger; }
                    else if (sys >= 140 || dia >= 90) { bpStatus = 'warning'; if (status !== 'danger') status = 'caution'; bpNote += 'Stage 1 HTN.'; if (status !== 'danger') patientMessage = t.msg_caution; }
                }
                doctorNotes.push({type: bpStatus, title: 'ê³ í˜ˆì••', content: bpNote});
            }

            if (answers.heart_disease) {
                riskLevel += 1;
                let hStatus = 'warning';
                let hContent = 'ì‹¬ì¥ ì§ˆí™˜ ë³‘ë ¥ í™•ì¸.';
                if (answers.heart_symptom_6mo) {
                    hStatus = 'critical';
                    status = 'danger';
                    patientMessage = t.msg_danger;
                    hContent = '!!ì£¼ì˜!! (Unstable/Recent History). ìµœê·¼ 6ê°œì›” ë‚´ ì¦ìƒ ìˆìŒ. ë¶ˆì•ˆì • í˜‘ì‹¬ì¦/MI ë“± ì˜ì‹¬. ì‘ê¸‰ìƒí™© ëŒ€ë¹„ ë° ë‚´ê³¼ ì˜ë¢° í•„ìˆ˜.';
                }
                doctorNotes.push({type: hStatus, title: 'ì‹¬ì¥ ì§ˆí™˜ (Heart Disease)', content: hContent});
            }

            if (answers.diabetes) {
                riskLevel += 1;
                const bsl = parseInt(answers.bs_level), isHigh = answers.bs_high_symptom, isLow = answers.bs_low_symptom;
                let dmNote = 'ì €í˜ˆë‹¹ ì£¼ì˜.';
                let dmStatus = 'monitor';
                if ((bsl >= 200) || isHigh) { dmStatus = 'warning'; if(status!=='danger') status='caution'; dmNote += ' ê³ í˜ˆë‹¹(>200).'; }
                else if ((bsl > 0 && bsl < 70) || isLow) { dmStatus = 'danger'; status='danger'; dmNote += ' ì €í˜ˆë‹¹(<70) ìœ„í—˜.'; patientMessage = t.msg_danger; }
                doctorNotes.push({type: dmStatus, title: 'ë‹¹ë‡¨', content: dmNote});
            }

            if (answers.anticoagulant) {
                if(status!=='danger') status='caution';
                patientMessage = t.msg_caution;
                doctorNotes.push({type: 'warning', title: 'í•­í˜ˆì „ì œ', content: 'ì§€í˜ˆ ì£¼ì˜. ì™€íŒŒë¦° INR í™•ì¸.'});
            }

            if (answers.bleeding_tendency) {
                status = 'danger'; patientMessage = t.msg_danger;
                doctorNotes.push({type: 'critical', title: 'ì¶œí˜ˆ ì†Œì¸', content: 'ì§€í˜ˆ ì§€ì—° ë³‘ë ¥. í˜ˆì•¡ê²€ì‚¬ í•„ìˆ˜.'});
            }

            if (answers.osteoporosis) {
                let osteoStatus = 'warning';
                let osteoContent = 'ê³¨ë‹¤ê³µì¦ ì•½ë¬¼ ë³µìš©.';
                if (answers.osteoporosis_type === 'injection') {
                    osteoStatus = 'danger';
                    status = 'danger';
                    patientMessage = t.msg_danger;
                    osteoContent = 'BRONJ ê³ ìœ„í—˜ (ì£¼ì‚¬ì œ/Injection). ë°œì¹˜/ì„í”Œë€íŠ¸ ì‹œ ê³¨ê´´ì‚¬ ìœ„í—˜ ë§¤ìš° ë†’ìŒ. íœ´ì•½ê¸° ë° ì „ë¬¸ì˜ í˜‘ì§„ í•„ìˆ˜.';
                } else {
                    if(status!=='danger') status='caution';
                    osteoContent += ' (ê²½êµ¬ì•½). BRONJ ìœ„í—˜ì„± ê³ ì§€.';
                }
                doctorNotes.push({type: osteoStatus, title: 'ê³¨ë‹¤ê³µì¦ (Osteoporosis)', content: osteoContent});
            }

            if (answers.infectious) {
                riskLevel += 1;
                if (status === 'safe') status = 'caution';
                let infDetails = [];
                if (answers.infectious_hbv) infDetails.push(t.disease_hbv);
                if (answers.infectious_hcv) infDetails.push(t.disease_hcv);
                if (answers.infectious_tb) infDetails.push(t.disease_tb);
                if (answers.infectious_hiv) infDetails.push(t.disease_hiv);
                if (answers.infectious_other) infDetails.push(`${t.disease_other}(${answers.infectious_other_text || '?'})`);
                
                let infNote = `ê°ì—¼ì„± ì§ˆí™˜: ${infDetails.join(', ') || 'ë¯¸ì„ íƒ'}. `;
                if (answers.infectious_tb) { status = 'danger'; infNote += '[ê²°í•µ] í™œë™ì„± í™•ì¸ í•„ìˆ˜. '; patientMessage = t.msg_danger; }
                infNote += 'Standard Precaution.';
                doctorNotes.push({ type: answers.infectious_tb ? 'danger' : 'warning', title: 'ê°ì—¼ì„± ì§ˆí™˜', content: infNote });
            }

            if (answers.steroid) {
                doctorNotes.push({type: 'warning', title: 'ìŠ¤í…Œë¡œì´ë“œ (Steroid)', content: 'ê°ì—¼ ì£¼ì˜ (Infection Risk). ë©´ì—­ ì–µì œ ê°€ëŠ¥ì„±. ìˆ  í›„ ê°ì—¼ ê´€ë¦¬ ë° ìŠ¤íŠ¸ë ˆìŠ¤ ê³ ë ¤.'});
            }

            if (answers.endocarditis) { status='danger'; patientMessage = t.msg_danger; doctorNotes.push({type: 'critical', title: 'ì‹¬ë‚´ë§‰ì—¼ ê³ ìœ„í—˜', content: 'ì˜ˆë°©ì  í•­ìƒì œ í•„ìˆ˜.'}); }
            if (answers.kidney_liver) { status='danger'; patientMessage = t.msg_danger; doctorNotes.push({type: 'warning', title: 'ì‹ ì¥/ê°„ ê¸°ëŠ¥', content: 'ì•½ë¬¼ ëŒ€ì‚¬/ì§€í˜ˆ ì£¼ì˜.'}); }
            if (answers.pregnancy) { if(status!=='danger') status='caution'; patientMessage = t.msg_caution; doctorNotes.push({type: 'monitor', title: 'ì„ì‹ ë¶€', content: '2ê¸° ì•ˆì „. ì•½ë¬¼ ê¸ˆê¸°.'}); }

            if (answers.other_meds) {
                doctorNotes.push({type: 'info', title: 'ê¸°íƒ€ ë³µìš© ì•½ë¬¼', content: answers.other_meds});
            }

            if (status === 'safe' && riskLevel > 0) status = 'caution';
            return { status, patientMessage, doctorNotes, riskLevel };
        };

        async function callGemini(systemPrompt, userPrompt, key) {
            if (!key) throw new Error("API Key Missing");
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
            const payload = { contents: [{ parts: [{ text: userPrompt }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };
            const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!res.ok) throw new Error("API Error");
            const data = await res.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "No response.";
        }

        function DentalScreeningApp() {
            // [Feature 1] Session Storage for Data Persistence
            const [answers, setAnswers] = useState(() => {
                try {
                    const saved = sessionStorage.getItem('dentalSafeCheck_answers');
                    return saved ? JSON.parse(saved) : {};
                } catch (e) { return {}; }
            });
            const [lang, setLang] = useState('ko');
            const [step, setStep] = useState('lang_select'); 
            const [viewMode, setViewMode] = useState('patient');
            const [localApiKey, setLocalApiKey] = useState(apiKey || localStorage.getItem('gemini_api_key') || '');
            const [showSettings, setShowSettings] = useState(false);
            const [aiLoading, setAiLoading] = useState(false);
            const [aiResult, setAiResult] = useState('');
            const [patientQuestion, setPatientQuestion] = useState('');
            const [aiError, setAiError] = useState('');

            // [Feature 1] Save to Session Storage on Change
            useEffect(() => {
                sessionStorage.setItem('dentalSafeCheck_answers', JSON.stringify(answers));
            }, [answers]);

            // [Feature 1] Scroll to Top on Step Change
            useEffect(() => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }, [step]);

            const t = TRANSLATIONS[lang];

            const handleAnswer = (id, value) => {
                setAnswers(prev => {
                    const next = { ...prev, [id]: value };
                    if (!value) {
                        if (id === 'hypertension') { delete next.bp_sys; delete next.bp_dia; }
                        if (id === 'heart_disease') { delete next.heart_symptom_6mo; }
                        if (id === 'diabetes') { delete next.bs_level; delete next.bs_high_symptom; delete next.bs_low_symptom; }
                        if (id === 'osteoporosis') { delete next.osteoporosis_type; }
                        if (id === 'infectious') { delete next.infectious_hbv; delete next.infectious_hcv; delete next.infectious_tb; delete next.infectious_hiv; delete next.infectious_other; delete next.infectious_other_text; }
                        if (id === 'dental_anesthesia') { delete next.dental_anesthesia_allergy; }
                    }
                    return next;
                });
            };
            const handleValueChange = (key, val) => setAnswers(p => ({...p, [key]: val}));
            
            const resetApp = () => { 
                setAnswers({}); 
                sessionStorage.removeItem('dentalSafeCheck_answers'); // Clear Storage
                setStep('lang_select'); 
                setViewMode('patient'); 
                setAiResult(''); 
                setPatientQuestion(''); 
            };
            
            const result = useMemo(() => analyzeCondition(answers, lang), [answers, lang]);
            
            const handleBack = () => {
                if (step === 'intro') setStep('lang_select');
                else if (step === 'basic_info') setStep('intro');
                else if (step === 'dental_habits') setStep('basic_info');
                else if (step === 'dental_history') setStep('dental_habits');
                else if (step === 'survey') setStep('dental_history');
                else if (step === 'result') setStep('survey');
            };
            
            const handleNext = () => setStep('result');

            // Validations
            const basicAnswered = answers.basic_gender && answers.basic_age && answers.basic_weight;
            const habitAnswered = answers.habit_visit_freq && answers.habit_painful && answers.habit_brushing && answers.habit_floss !== undefined;
            const dentalAnswered = answers.dental_extraction !== undefined && answers.dental_anesthesia !== undefined && (answers.dental_anesthesia === false || answers.dental_anesthesia_allergy !== undefined);
            const medicalAnswered = QUESTIONS.every(q => {
                if (q.id === 'heart_disease' && answers.heart_disease) return answers.heart_symptom_6mo !== undefined;
                if (q.id === 'osteoporosis' && answers.osteoporosis) return answers.osteoporosis_type !== undefined;
                return answers[q.id] !== undefined;
            });

            // AI Features
            const askPatientAI = async () => {
                if (!patientQuestion.trim()) return;
                if (!localApiKey) { setShowSettings(true); return; }
                setAiLoading(true); setAiResult(''); setAiError('');
                const conditionSummary = QUESTIONS.filter(q => answers[q.id]).map(q => t[q.key]).join(", ");
                const sysPrompt = `Act as Dental Receptionist AI. Lang: ${lang}. Patient: ${conditionSummary}. Status: ${result.status}. Answer simple/polite in ${lang}.`;
                try { const text = await callGemini(sysPrompt, patientQuestion, localApiKey); setAiResult(text); } catch (e) { setAiError("Error"); } finally { setAiLoading(false); }
            };
            const generateReferralLetter = async () => {
                if (!localApiKey) { setShowSettings(true); return; }
                setAiLoading(true); setAiResult('');
                const sysPrompt = `Act as Dentist. Write referral letter (Korean) to Physician. Risks: ${JSON.stringify(result.doctorNotes)}.`;
                try { const text = await callGemini(sysPrompt, "Write Letter", localApiKey); setAiResult(text); } catch (e) { setAiError("Error"); } finally { setAiLoading(false); }
            };

            const fontClass = lang === 'zh' ? 'lang-sc' : lang === 'ja' ? 'lang-jp' : lang === 'ar' ? 'lang-ar' : '';

            // [Feature 2] Specialized A4 Print Layout Component
            const PrintLayout = () => {
                const mapVisit = { 'pain': 'ì•„í”Œ ë•Œë§Œ', 'uncomfortable': 'ë¶ˆí¸í•  ë•Œ', 'periodic': 'ì •ê¸°ì ' };
                const mapPain = { 'yes': 'ì‹¬í•¨', 'no': 'ì—†ìŒ/ë³´í†µ' };
                const mapFloss = { true: 'ì‚¬ìš©', false: 'ë¯¸ì‚¬ìš©' };
                const today = new Date().toLocaleDateString();

                return (
                    <div className="print-only">
                        {/* Header */}
                        <div className="border-b-2 border-black pb-4 mb-4">
                            <h1 className="text-3xl font-bold text-center mb-2">ì¹˜ê³¼ ì§„ë£Œ ì „ í™˜ì ì•ˆì „ ì ê²€í‘œ</h1>
                            <div className="text-center text-xs text-gray-500 mb-6">Patient Safety Check Report for Dental Treatment</div>
                            <div className="grid grid-cols-2 gap-x-8 gap-y-2 text-sm">
                                <div className="flex border-b border-gray-300 pb-1"><span className="font-bold w-24">ì„±ëª… (Name):</span><span className="flex-1"></span></div>
                                <div className="flex border-b border-gray-300 pb-1"><span className="font-bold w-24">ì°¨íŠ¸ ë²ˆí˜¸:</span><span className="flex-1"></span></div>
                                <div className="flex border-b border-gray-300 pb-1"><span className="font-bold w-24">ìƒë…„ì›”ì¼:</span><span className="flex-1"></span></div>
                                <div className="flex border-b border-gray-300 pb-1"><span className="font-bold w-24">ì‘ì„±ì¼ì:</span><span className="flex-1">{today}</span></div>
                                <div className="flex border-b border-gray-300 pb-1"><span className="font-bold w-24">ì‹ ì²´ ì •ë³´:</span><span className="flex-1">{answers.basic_gender==='male'?'ë‚¨ì„±':'ì—¬ì„±'} / {answers.basic_age}ì„¸ / {answers.basic_weight}kg</span></div>
                            </div>
                        </div>

                        {/* Summary Box */}
                        <div className="mb-6 p-4 border border-black rounded-lg">
                            <h2 className="font-bold border-b border-black pb-2 mb-2">1. ì¢…í•© ë¶„ì„ ê²°ê³¼ (Clinical Summary)</h2>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <span className="font-bold text-sm block">ì•ˆì „ ë“±ê¸‰ (Safety Level):</span>
                                    <span className={`text-xl font-bold ${result.status==='safe'?'':'underline'}`}>
                                        {result.status.toUpperCase()} ({result.status==='safe'?'ì•ˆì „':'ì£¼ì˜/ìœ„í—˜'})
                                    </span>
                                </div>
                                <div>
                                    <span className="font-bold text-sm block">ì‘ì„± ì–¸ì–´:</span>
                                    <span>{lang.toUpperCase()}</span>
                                </div>
                            </div>
                        </div>

                        {/* Medical Alerts (Auto-Analysis) */}
                        <div className="mb-6">
                            <h2 className="font-bold text-lg mb-2">2. ì„ìƒ ì£¼ì˜ì‚¬í•­ (Medical Alerts)</h2>
                            {result.doctorNotes.length === 0 ? (
                                <div className="p-4 border border-dashed border-gray-400 text-center text-gray-500">íŠ¹ì´ì‚¬í•­ ì—†ìŒ (Nonspecific)</div>
                            ) : (
                                <table className="w-full">
                                    <thead><tr><th style={{width:'15%'}}>êµ¬ë¶„</th><th>ë‚´ìš© (Clinical Note)</th></tr></thead>
                                    <tbody>
                                        {result.doctorNotes.map((n, i) => (
                                            <tr key={i}>
                                                <td className="font-bold text-center">{n.title}</td>
                                                <td>{n.content}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            )}
                        </div>

                        {/* Detailed History Table */}
                        <div className="mb-6">
                            <h2 className="font-bold text-lg mb-2">3. ìƒì„¸ ë¬¸ì§„ ë‚´ì—­ (Detailed History)</h2>
                            <table className="w-full mb-4">
                                <tbody>
                                    <tr>
                                        <th style={{width:'20%'}}>êµ¬ê°• ìŠµê´€</th>
                                        <td>
                                            ë°©ë¬¸: {mapVisit[answers.habit_visit_freq]} | 
                                            ê³¼ê±°í†µì¦: {mapPain[answers.habit_painful]} | 
                                            ì–‘ì¹˜: {answers.habit_brushing}íšŒ/ì¼ | 
                                            ë³´ì¡°ìš©í’ˆ: {mapFloss[answers.habit_floss]}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>ì¹˜ê³¼ ì´ë ¥</th>
                                        <td>
                                            ë°œì¹˜ê²½í—˜: {answers.dental_extraction?'ìˆìŒ':'ì—†ìŒ'} | 
                                            ë§ˆì·¨ê²½í—˜: {answers.dental_anesthesia?'ìˆìŒ':'ì—†ìŒ'}
                                            {answers.dental_anesthesia && ` (ì•ŒëŸ¬ì§€: ${answers.dental_anesthesia_allergy?'ìˆìŒ':'ì—†ìŒ'})`}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>ì „ì‹  ì§ˆí™˜</th>
                                        <td>
                                            {QUESTIONS.filter(q => answers[q.id]).length === 0 ? 'íŠ¹ì´ì‚¬í•­ ì—†ìŒ' : (
                                                <div className="grid grid-cols-2 gap-1">
                                                    {answers.hypertension && <div>â€¢ ê³ í˜ˆì•• ({answers.bp_sys}/{answers.bp_dia})</div>}
                                                    {answers.heart_disease && <div>â€¢ ì‹¬ì¥ì§ˆí™˜ (ì¦ìƒ: {answers.heart_symptom_6mo?'ìœ ':'ë¬´'})</div>}
                                                    {answers.diabetes && <div>â€¢ ë‹¹ë‡¨ (BST: {answers.bs_level})</div>}
                                                    {answers.anticoagulant && <div>â€¢ í•­í˜ˆì „ì œ ë³µìš©</div>}
                                                    {answers.bleeding_tendency && <div>â€¢ ì¶œí˜ˆ ì†Œì¸</div>}
                                                    {answers.osteoporosis && <div>â€¢ ê³¨ë‹¤ê³µì¦ ({answers.osteoporosis_type==='injection'?'ì£¼ì‚¬':'ê²½êµ¬'})</div>}
                                                    {answers.infectious && <div>â€¢ ê°ì—¼ì„± ì§ˆí™˜</div>}
                                                    {answers.steroid && <div>â€¢ ìŠ¤í…Œë¡œì´ë“œ</div>}
                                                    {answers.endocarditis && <div>â€¢ ì‹¬ë‚´ë§‰ì—¼</div>}
                                                    {answers.kidney_liver && <div>â€¢ ì‹ ì¥/ê°„ ì§ˆí™˜</div>}
                                                    {answers.pregnancy && <div>â€¢ ì„ì‹  ê°€ëŠ¥ì„±</div>}
                                                </div>
                                            )}
                                        </td>
                                    </tr>
                                    {answers.other_meds && (
                                        <tr>
                                            <th>ê¸°íƒ€ ì•½ë¬¼</th>
                                            <td>{answers.other_meds}</td>
                                        </tr>
                                    )}
                                </tbody>
                            </table>
                        </div>

                        {/* Signature */}
                        <div className="mt-12 flex justify-end gap-12">
                            <div className="text-right">
                                <p className="mb-6">ìƒê¸° ë‚´ìš©ì€ ì‚¬ì‹¤ê³¼ ë‹¤ë¦„ì—†ìŒì„ í™•ì¸í•©ë‹ˆë‹¤.</p>
                                <div className="flex gap-4 items-end">
                                    <span>í™˜ì ì„œëª…:</span>
                                    <span className="w-32 border-b border-black"></span>
                                </div>
                            </div>
                            <div className="text-right">
                                <p className="mb-6 text-transparent">.</p>
                                <div className="flex gap-4 items-end">
                                    <span>ë‹´ë‹¹ì˜ í™•ì¸:</span>
                                    <span className="w-32 border-b border-black"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className={`min-h-screen bg-slate-50 flex justify-center ${fontClass}`} dir={lang === 'ar' ? 'rtl' : 'ltr'}>
                    <div className="w-full max-w-md bg-white min-h-screen shadow-xl overflow-hidden flex flex-col relative">
                        {/* API Settings Modal */}
                        {showSettings && (
                            <div className="absolute inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                                <div className="bg-white p-6 rounded-xl w-full max-w-sm">
                                    <h3 className="font-bold mb-2">API Key</h3>
                                    <input type="password" value={localApiKey} onChange={e=>setLocalApiKey(e.target.value)} className="w-full p-2 border rounded mb-4"/>
                                    <button onClick={()=>setShowSettings(false)} className="w-full bg-blue-600 text-white py-2 rounded">Save</button>
                                </div>
                            </div>
                        )}

                        {/* Header */}
                        {step !== 'lang_select' && (
                            <header className="bg-blue-600 text-white p-4 flex items-center justify-between shadow-md z-10 no-print">
                                <div className="flex items-center gap-2"><Icons.Stethoscope className="h-6 w-6" /><h1 className="text-lg font-bold">Dental Safe Check</h1></div>
                                <div className="flex gap-2 items-center">
                                    {step === 'result' && <button onClick={()=>window.print()}><Icons.Printer size={20}/></button>}
                                    <button onClick={resetApp}><Icons.RefreshCcw size={20}/></button>
                                    <button onClick={()=>setShowSettings(!showSettings)}><Icons.Settings size={20}/></button>
                                </div>
                            </header>
                        )}

                        <main className="flex-1 overflow-y-auto p-4">
                            {/* [Feature 2] Print Layout Component (Hidden on Screen, Visible on Print) */}
                            {step === 'result' && <PrintLayout />}

                            {/* 0. Lang Select */}
                            {step === 'lang_select' && (
                                <div className="flex flex-col items-center justify-center h-full space-y-8 animate-fadeIn">
                                    <div className="text-center"><div className="inline-block p-4 bg-blue-50 rounded-full mb-4"><Icons.Globe className="w-16 h-16 text-blue-600"/></div><h2 className="text-2xl font-bold">Select Language</h2></div>
                                    <div className="grid grid-cols-1 gap-3 w-full px-8">
                                        {[
                                            {c:'ko',l:'ğŸ‡°ğŸ‡· í•œêµ­ì–´'},{c:'en',l:'ğŸ‡ºğŸ‡¸ English'},{c:'zh',l:'ğŸ‡¨ğŸ‡³ ä¸­æ–‡'},
                                            {c:'ja',l:'ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª'},{c:'vi',l:'ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t'},{c:'mn',l:'ğŸ‡²ğŸ‡³ ĞœĞ¾Ğ½Ğ³Ğ¾Ğ» Ñ…ÑĞ»'},{c:'ar',l:'ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©'}
                                        ].map(o=><button key={o.c} onClick={()=>{setLang(o.c);setStep('intro');}} className="py-3 border rounded-xl hover:bg-blue-50 font-bold">{o.l}</button>)}
                                    </div>
                                </div>
                            )}

                            {/* 1. Intro */}
                            {step === 'intro' && (
                                <div className="flex flex-col items-center justify-center h-full text-center space-y-6 animate-fadeIn">
                                    <div className="bg-blue-50 p-6 rounded-full"><Icons.ShieldAlert className="h-20 w-20 text-blue-600"/></div>
                                    <div><h2 className="text-2xl font-bold mb-2">{t.title}</h2><p className="text-slate-500">{t.subtitle}</p></div>
                                    <div className="bg-slate-100 p-3 rounded-lg text-xs text-slate-500 flex gap-2 text-left mx-4"><Icons.Lock size={16} className="shrink-0 mt-0.5"/><span>{t.privacyNotice}</span></div>
                                    <button onClick={()=>setStep('basic_info')} className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-blue-700">{t.startBtn}</button>
                                </div>
                            )}

                            {/* 1.5 Basic Info */}
                            {step === 'basic_info' && (
                                <div className="space-y-6 pb-20 animate-fadeIn">
                                    <div className="bg-blue-50 border-l-4 border-blue-400 p-4 rounded text-sm text-blue-800 mb-4 flex gap-2"><Icons.Scale size={18}/><strong>{t.basicInfoTitle}</strong></div>
                                    <div className="bg-white border rounded-xl p-5 shadow-sm space-y-4">
                                        <div>
                                            <label className="block text-sm font-bold mb-2">{t.label_gender}</label>
                                            <div className="grid grid-cols-2 gap-3">
                                                <button onClick={()=>handleValueChange('basic_gender','male')} className={`py-3 rounded-lg font-semibold ${answers.basic_gender==='male'?'bg-blue-600 text-white':'bg-slate-100'}`}>{t.gender_male}</button>
                                                <button onClick={()=>handleValueChange('basic_gender','female')} className={`py-3 rounded-lg font-semibold ${answers.basic_gender==='female'?'bg-pink-500 text-white':'bg-slate-100'}`}>{t.gender_female}</button>
                                            </div>
                                        </div>
                                        <div><label className="block text-sm font-bold mb-1">{t.label_age}</label><input type="number" placeholder={t.placeholder_age} value={answers.basic_age||''} onChange={e=>handleValueChange('basic_age',e.target.value)} className="w-full p-3 border rounded-lg"/></div>
                                        <div><label className="block text-sm font-bold mb-1">{t.label_weight}</label><input type="number" placeholder={t.placeholder_weight} value={answers.basic_weight||''} onChange={e=>handleValueChange('basic_weight',e.target.value)} className="w-full p-3 border rounded-lg"/></div>
                                    </div>
                                </div>
                            )}

                            {/* 1.6 Habits */}
                            {step === 'dental_habits' && (
                                <div className="space-y-6 pb-20 animate-fadeIn">
                                    <div className="bg-blue-50 border-l-4 border-blue-400 p-4 rounded text-sm text-blue-800 mb-4 flex gap-2"><Icons.Brush size={18}/><strong>{t.habitInfoTitle}</strong></div>
                                    <div className="bg-white border rounded-xl p-5 shadow-sm space-y-3">
                                        <h3 className="font-bold">{t.q_visit_freq}</h3>
                                        <div className="flex flex-col gap-2">{['pain','uncomfortable','periodic'].map(o=><button key={o} onClick={()=>handleValueChange('habit_visit_freq',o)} className={`py-3 px-4 rounded-lg text-left text-sm border ${answers.habit_visit_freq===o?'bg-blue-50 border-blue-500 text-blue-700':'bg-white'}`}>{t[`opt_visit_${o}`]}</button>)}</div>
                                    </div>
                                    <div className="bg-white border rounded-xl p-5 shadow-sm space-y-3">
                                        <h3 className="font-bold">{t.q_prev_discomfort}</h3>
                                        <div className="grid grid-cols-2 gap-3"><button onClick={()=>handleValueChange('habit_painful','yes')} className={`py-3 rounded-lg text-sm ${answers.habit_painful==='yes'?'bg-red-50 text-red-700 border-red-200':'bg-slate-100'}`}>{t.opt_painful}</button><button onClick={()=>handleValueChange('habit_painful','no')} className={`py-3 rounded-lg text-sm ${answers.habit_painful==='no'?'bg-blue-50 text-blue-700 border-blue-200':'bg-slate-100'}`}>{t.opt_okay}</button></div>
                                    </div>
                                    <div className="bg-white border rounded-xl p-5 shadow-sm space-y-5">
                                        <div><h3 className="font-bold mb-2">{t.q_brushing}</h3><input type="number" placeholder="3" value={answers.habit_brushing||''} onChange={e=>handleValueChange('habit_brushing',e.target.value)} className="w-full p-3 border rounded-lg"/></div>
                                        <div className="border-t pt-4"><h3 className="font-bold mb-3">{t.q_floss}</h3><div className="grid grid-cols-2 gap-3"><button onClick={()=>handleValueChange('habit_floss',true)} className={`py-3 rounded-lg ${answers.habit_floss===true?'bg-green-600 text-white':'bg-slate-100'}`}>{t.yes}</button><button onClick={()=>handleValueChange('habit_floss',false)} className={`py-3 rounded-lg ${answers.habit_floss===false?'bg-slate-600 text-white':'bg-slate-100'}`}>{t.no}</button></div></div>
                                    </div>
                                </div>
                            )}

                            {/* 2. Dental History */}
                            {step === 'dental_history' && (
                                <div className="space-y-6 pb-20 animate-fadeIn">
                                    <div className="bg-blue-50 border-l-4 border-blue-400 p-4 rounded text-sm text-blue-800 mb-4 flex gap-2"><Icons.Tooth size={18}/><strong>{t.dentalHistoryTitle}</strong></div>
                                    {/* Extraction */}
                                    <div className="bg-white border rounded-xl p-5 shadow-sm"><h3 className="font-bold">{t.q_extraction}</h3><div className="grid grid-cols-2 gap-3 mt-4"><button onClick={()=>handleAnswer('dental_extraction',true)} className={`py-3 rounded-lg ${answers.dental_extraction===true?'bg-blue-600 text-white':'bg-slate-100'}`}>{t.yes}</button><button onClick={()=>handleAnswer('dental_extraction',false)} className={`py-3 rounded-lg ${answers.dental_extraction===false?'bg-slate-600 text-white':'bg-slate-100'}`}>{t.no}</button></div></div>
                                    {/* Anesthesia */}
                                    <div className="bg-white border rounded-xl p-5 shadow-sm"><h3 className="font-bold">{t.q_anesthesia}</h3><div className="grid grid-cols-2 gap-3 mt-4"><button onClick={()=>handleAnswer('dental_anesthesia',true)} className={`py-3 rounded-lg ${answers.dental_anesthesia===true?'bg-blue-600 text-white':'bg-slate-100'}`}>{t.yes}</button><button onClick={()=>handleAnswer('dental_anesthesia',false)} className={`py-3 rounded-lg ${answers.dental_anesthesia===false?'bg-slate-600 text-white':'bg-slate-100'}`}>{t.no}</button></div>
                                        {answers.dental_anesthesia && (<div className="mt-4 pt-4 border-t"><h3 className="font-bold text-red-600">{t.q_allergy}</h3><p className="text-xs text-slate-500">{t.q_allergy_detail}</p><div className="grid grid-cols-2 gap-3 mt-4"><button onClick={()=>handleAnswer('dental_anesthesia_allergy',true)} className={`py-3 rounded-lg ${answers.dental_anesthesia_allergy===true?'bg-red-600 text-white':'bg-slate-100'}`}>{t.yes_had}</button><button onClick={()=>handleAnswer('dental_anesthesia_allergy',false)} className={`py-3 rounded-lg ${answers.dental_anesthesia_allergy===false?'bg-slate-600 text-white':'bg-slate-100'}`}>{t.no}</button></div></div>)}
                                    </div>
                                </div>
                            )}

                            {/* 3. Medical Survey */}
                            {step === 'survey' && (
                                <div className="space-y-6 pb-20 animate-fadeIn">
                                    <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded text-sm text-yellow-800 mb-4">{t.medHistoryTitle}: {t.medHistoryDesc}</div>
                                    {QUESTIONS.map(q => (
                                        <div key={q.id} className="bg-white border rounded-xl p-5 shadow-sm">
                                            <div className="flex gap-3 mb-3">
                                                {q.category==='cardio'?<Icons.HeartPulse className="text-red-500 shrink-0"/>:q.category==='medication'?<Icons.Pill className="text-green-500 shrink-0"/>:q.category==='endocrine'?<Icons.Activity className="text-orange-500 shrink-0"/>:<Icons.Syringe className="text-purple-500 shrink-0"/>}
                                                <div><h3 className="font-bold">{t[q.key]}</h3><p className="text-xs text-slate-400">{t[q.detailKey]}</p></div>
                                            </div>
                                            <div className="grid grid-cols-2 gap-3 mt-4">
                                                <button onClick={()=>handleAnswer(q.id,true)} className={`py-3 rounded-lg font-semibold ${answers[q.id]===true?'bg-blue-600 text-white':'bg-slate-100'}`}>{t.yes}</button>
                                                <button onClick={()=>handleAnswer(q.id,false)} className={`py-3 rounded-lg font-semibold ${answers[q.id]===false?'bg-slate-600 text-white':'bg-slate-100'}`}>{t.no}</button>
                                            </div>
                                            
                                            {/* Sub Inputs */}
                                            {answers[q.id] && q.id==='hypertension' && (
                                                <div className="mt-4 pt-4 border-t border-dashed"><p className="text-sm font-bold text-blue-800 mb-2">{t.placeholder_bp}</p><div className="flex gap-2"><input type="number" placeholder="120" value={answers.bp_sys||''} onChange={e=>handleValueChange('bp_sys',e.target.value)} className="w-full p-2 border rounded text-center"/><span className="text-xl">/</span><input type="number" placeholder="80" value={answers.bp_dia||''} onChange={e=>handleValueChange('bp_dia',e.target.value)} className="w-full p-2 border rounded text-center"/></div></div>
                                            )}
                                            {answers[q.id] && q.id==='heart_disease' && (
                                                <div className="mt-4 pt-4 border-t border-dashed"><p className="text-sm font-bold text-red-800 mb-2">{t.q_heart_symptom}</p><div className="grid grid-cols-2 gap-2"><button onClick={()=>handleValueChange('heart_symptom_6mo',true)} className={`p-2 border rounded text-sm ${answers.heart_symptom_6mo===true?'bg-red-100 border-red-500 text-red-700':''}`}>{t.yes}</button><button onClick={()=>handleValueChange('heart_symptom_6mo',false)} className={`p-2 border rounded text-sm ${answers.heart_symptom_6mo===false?'bg-slate-100 text-slate-700':''}`}>{t.no}</button></div></div>
                                            )}
                                            {answers[q.id] && q.id==='diabetes' && (
                                                <div className="mt-4 pt-4 border-t border-dashed"><p className="text-sm font-bold text-orange-800 mb-2">{t.placeholder_bs}</p><input type="number" placeholder="mg/dL" value={answers.bs_level||''} onChange={e=>handleValueChange('bs_level',e.target.value)} className="w-full p-2 border rounded mb-2"/><div className="grid grid-cols-2 gap-2"><button onClick={()=>handleValueChange('bs_high_symptom',!answers.bs_high_symptom)} className={`p-2 border rounded text-sm ${answers.bs_high_symptom?'bg-orange-100 border-orange-500':''}`}>High Sugar Symptom</button><button onClick={()=>handleValueChange('bs_low_symptom',!answers.bs_low_symptom)} className={`p-2 border rounded text-sm ${answers.bs_low_symptom?'bg-red-100 border-red-500':''}`}>Low Sugar Symptom</button></div></div>
                                            )}
                                            {answers[q.id] && q.id==='osteoporosis' && (
                                                <div className="mt-4 pt-4 border-t border-dashed"><p className="text-sm font-bold text-slate-800 mb-2">{t.q_osteo_type}</p><div className="grid grid-cols-2 gap-2"><button onClick={()=>handleValueChange('osteoporosis_type','oral')} className={`p-2 border rounded text-sm ${answers.osteoporosis_type==='oral'?'bg-blue-100 border-blue-500':''}`}>{t.opt_oral}</button><button onClick={()=>handleValueChange('osteoporosis_type','injection')} className={`p-2 border rounded text-sm ${answers.osteoporosis_type==='injection'?'bg-red-100 border-red-500 text-red-700 font-bold':''}`}>{t.opt_inject}</button></div></div>
                                            )}
                                            {answers[q.id] && q.id==='infectious' && (
                                                <div className="mt-4 pt-4 border-t border-dashed"><p className="text-sm font-bold text-orange-800 mb-2">{t.placeholder_infectious}</p><div className="space-y-2">{['hbv','hcv','tb','hiv','other'].map(k=><div key={k}><label className="flex items-center gap-2 p-2 border rounded hover:bg-slate-50"><input type="checkbox" checked={answers[`infectious_${k}`]||false} onChange={e=>handleValueChange(`infectious_${k}`,e.target.checked)} className="w-5 h-5"/><span>{t[`disease_${k}`]}</span></label>{k==='other'&&answers.infectious_other&&( <input type="text" placeholder={t.input_other} value={answers.infectious_other_text||''} onChange={e=>handleValueChange('infectious_other_text',e.target.value)} className="w-full mt-2 p-2 border rounded text-sm"/>)}</div>)}</div></div>
                                            )}
                                        </div>
                                    ))}
                                    {/* Other Meds Input */}
                                    <div className="bg-white border rounded-xl p-5 shadow-sm mt-4">
                                        <h3 className="font-bold text-lg mb-2">{t.q_other_meds}</h3>
                                        <textarea value={answers.other_meds||''} onChange={e=>handleValueChange('other_meds',e.target.value)} className="w-full p-3 border rounded-lg h-24 resize-none" placeholder={t.input_other}></textarea>
                                    </div>
                                </div>
                            )}

                            {/* 4. Results */}
                            {step === 'result' && (
                                <div className="animate-fadeIn pb-20 no-print">
                                    <div className="flex bg-slate-200 p-1 rounded-lg mb-6 no-print">
                                        <button onClick={()=>{setViewMode('patient');setAiResult('');}} className={`flex-1 py-2 text-sm font-bold rounded-md ${viewMode==='patient'?'bg-white text-blue-600 shadow':'text-slate-500'}`}><Icons.User size={16}/> {t.result_patient}</button>
                                        <button onClick={()=>{setViewMode('doctor');setAiResult('');}} className={`flex-1 py-2 text-sm font-bold rounded-md ${viewMode==='doctor'?'bg-slate-800 text-white shadow':'text-slate-500'}`}><Icons.UserCheck size={16}/> {t.result_doctor}</button>
                                    </div>

                                    {/* Patient View */}
                                    {viewMode === 'patient' && (
                                        <div className="space-y-6">
                                            <div className={`p-8 rounded-3xl flex flex-col items-center justify-center space-y-4 shadow-lg border-4 text-center ${result.status==='safe'?'bg-green-50 border-green-100':result.status==='caution'?'bg-yellow-50 border-yellow-100':'bg-red-50 border-red-100'}`}>{result.status==='safe'&&<Icons.CheckCircle className="w-24 h-24 text-green-500"/>}{result.status==='caution'&&<Icons.AlertTriangle className="w-24 h-24 text-yellow-500"/>}{result.status==='danger'&&<Icons.ShieldAlert className="w-24 h-24 text-red-500"/>}<h2 className="text-2xl font-bold">{t[result.status]}</h2><p className="text-slate-600 font-medium whitespace-pre-line">{result.patientMessage}</p></div>
                                            <div className="bg-blue-50 border border-blue-100 rounded-xl p-5 no-print"><div className="flex items-center gap-2 mb-3"><Icons.Sparkles className="text-blue-600 w-5 h-5"/> <h3 className="font-bold text-blue-900">{t.ai_title}</h3></div><p className="text-xs text-blue-700 mb-3">{t.ai_desc}</p><div className="flex gap-2"><input type="text" value={patientQuestion} onChange={e=>setPatientQuestion(e.target.value)} placeholder={t.ai_placeholder} className="flex-1 p-2 border rounded outline-none text-sm"/><button onClick={askPatientAI} disabled={aiLoading} className="bg-blue-600 text-white px-4 rounded font-bold text-sm">{aiLoading?<div className="loader"></div>:t.ai_btn}</button></div>{aiResult&&<div className="mt-4 bg-white p-4 rounded border text-sm" dangerouslySetInnerHTML={{__html: marked.parse(aiResult)}}/>}{aiError&&<p className="text-red-500 text-xs mt-2">{aiError}</p>}</div>
                                            <div className="bg-white p-5 rounded-xl shadow-sm border"><h3 className="font-bold text-slate-700 mb-3 flex items-center gap-2"><Icons.FileText size={18}/> {t.items_checked}</h3><ul className="space-y-2 text-sm"><li className="text-sm bg-slate-50 p-2 rounded text-slate-700 border border-slate-100"><span className="font-bold text-blue-600">â€¢ {t.basicInfoTitle}:</span> {answers.basic_gender==='male'?t.gender_male:t.gender_female} / {answers.basic_age} / {answers.basic_weight}kg</li>{(!answers.dental_extraction && !answers.dental_anesthesia && !QUESTIONS.some(q=>answers[q.id]))?<li className="text-slate-400">{t.none}</li>:(<>{answers.dental_extraction&&<li>â€¢ {t.q_extraction}</li>}{answers.dental_anesthesia&&<li>â€¢ {t.q_anesthesia} {answers.dental_anesthesia_allergy?`(${t.q_allergy}: ${t.yes})`:''}</li>}{QUESTIONS.filter(q=>answers[q.id]).map(q=><li key={q.id}>â€¢ {t[q.key]}</li>)}</>)}</ul></div>
                                        </div>
                                    )}

                                    {/* Doctor View */}
                                    {viewMode === 'doctor' && (
                                        <div className="space-y-4">
                                            <div className="bg-slate-800 text-white p-4 rounded-xl shadow-lg"><h3 className="font-bold text-lg flex items-center gap-2"><Icons.Stethoscope size={20}/> Clinical Summary (KR)</h3><div className="text-sm mt-1">Status: <span className={`font-bold px-1 rounded ${result.status==='safe'?'bg-green-500':result.status==='caution'?'bg-yellow-500 text-black':'bg-red-500'}`}>{result.status.toUpperCase()}</span> | Language: {lang.toUpperCase()}</div></div>
                                            {result.doctorNotes.length>0&&( <div className="bg-white border p-4 rounded-xl shadow-sm no-print"><h4 className="font-bold text-slate-700 flex gap-2 mb-2"><Icons.Sparkles size={16} className="text-purple-600"/> AI Assistance (KR)</h4><button onClick={generateReferralLetter} disabled={aiLoading} className="w-full py-2 bg-purple-50 text-purple-700 border border-purple-200 rounded font-bold text-sm flex justify-center gap-2">{aiLoading?<div className="loader"></div>:'ì§„ë£Œ ì˜ë¢°ì„œ ì‘ì„± (Referral Letter)'}</button>{aiResult&&<div className="mt-3 bg-slate-50 p-4 rounded border text-sm font-mono whitespace-pre-wrap">{aiResult}</div>}</div>)}
                                            {result.doctorNotes.length===0?<div className="text-center py-10 bg-white border border-dashed rounded-xl text-slate-500">No Specific Contraindications</div>:result.doctorNotes.map((n,i)=>(<div key={i} className={`border-l-4 rounded-r-xl p-4 bg-white shadow-sm ${n.type==='critical'?'border-red-600':n.type==='danger'?'border-orange-500':n.type==='warning'?'border-yellow-500':n.type==='info'?'border-sky-500 bg-sky-50':'border-blue-500'}`}><h4 className="font-bold text-sm mb-1 flex items-center gap-2">{n.type==='critical'?<Icons.AlertTriangle size={16} className="text-red-600"/>:n.type==='info'?<Icons.Scale size={16} className="text-sky-600"/>:null}{n.title}</h4><p className="text-sm text-slate-600 whitespace-pre-line">{n.content}</p></div>))}
                                        </div>
                                    )}
                                </div>
                            )}
                        </main>

                        {/* Footer Buttons */}
                        {step !== 'lang_select' && step !== 'result' && (
                            <div className="p-4 bg-white border-t no-print flex gap-3">
                                {step !== 'intro' && (
                                    <>
                                        <button 
                                            onClick={handleBack}
                                            className="w-1/3 py-4 rounded-xl font-bold text-lg bg-slate-100 text-slate-500 hover:bg-slate-200 transition flex items-center justify-center gap-1"
                                        >
                                            <Icons.ChevronLeft /> {t.btn_back}
                                        </button>
                                        <button 
                                            onClick={()=>{
                                                if(step==='basic_info')setStep('dental_habits');
                                                else if(step==='dental_habits')setStep('dental_history');
                                                else if(step==='dental_history')setStep('survey');
                                                else handleNext();
                                            }}
                                            disabled={step==='basic_info'?!basicAnswered:step==='dental_habits'?!habitAnswered:step==='dental_history'?!dentalAnswered:!medicalAnswered}
                                            className={`flex-1 py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-2 shadow-lg transition ${(step==='basic_info'?basicAnswered:step==='dental_habits'?habitAnswered:step==='dental_history'?dentalAnswered:medicalAnswered)?'bg-blue-600 text-white hover:bg-blue-700 active:scale-95':'bg-slate-200 text-slate-400 cursor-not-allowed'}`}
                                        >
                                            {step==='basic_info'?t.btn_next_basic:step==='dental_habits'?t.btn_next_habit:step==='dental_history'?t.btn_next:t.btn_result} <Icons.ChevronRight/>
                                        </button>
                                    </>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<DentalScreeningApp />);
    </script>
</body>
</html>